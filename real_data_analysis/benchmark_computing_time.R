# Benchmark computing time for scMultiMap, SCENT and Signac
# on 10X PBMC data.

library(dplyr)
library(Seurat)
library(SCENT)
library(scMultiMap)
library(optparse)

option_list = list(
    make_option(c("--study"), type="character", default="PBMC_3k",
              help="which dataset to analyze", metavar="character"),
    make_option(c("--i_rep"), type="integer", default=1,
              help="which replicate", metavar="integer"),
    make_option(c("--pair_prop"), type="numeric", default=0.05,
              help="proportion of pairs to run for SCENT", metavar="numeric")
)

opt_parser = OptionParser(option_list=option_list);
opt = parse_args(opt_parser);
study <- opt$study
i_rep <- opt$i_rep
pair_prop <- opt$pair_prop
fn <- sprintf('computing_time_i_rep_%i', i_rep)
print(fn)

pn <- 'peaks_ct'
obj_suffix <- ''
ct <- 'CD14 Mono'
p_top_gene <- 2000
p_top_peak <- 20000
adjust_for_batch <- FALSE

pre_dir <- sprintf('../../analysis/preprocessing/output/%s/%s', study, ct)
output_dir <- '../manuscript/results/'# sprintf('../../analysis/real_data/output/%s/%s', study, ct)

# load data - generated by preprocessing/save_seurat_obj_by_ct.R
ct_obj <- readRDS(sprintf('%s_seurat_obj%s.rds', pre_dir, obj_suffix))

# -
# scMultiMap
# -

#if(!file.exists(sprintf('%s_scMultiMap_%s.rds', output_dir, fn))){
    pairs_df <- get_top_peak_gene_pairs(ct_obj,
                                        gene_top=2000, peak_top=20000,
                                        distance = 5e+5,
                                        gene_assay = 'RNA', # name of the gene assay
                                        peak_assay = pn) # name of the peak assay
    print('scMultiMap started')
    start <- Sys.time()
    scMultiMap_res <- scMultiMap(ct_obj, pairs_df,
                                gene_assay = 'RNA', # name of the gene assay
                                peak_assay = pn) # name of the peak assay

    end <- Sys.time()
    print(end)
    print('scMultiMap')
    saveRDS(end - start, sprintf('%s_scMultiMap_%s.rds', output_dir, fn))
#}

# - 
# Signac
# -
if(!file.exists(sprintf('%s_Siganc_%s.rds', output_dir, fn))){
    print('Signac started')
    start <- Sys.time()
    print(start)
    set.seed(1)
    # similar to the analysis in Signac tutorial
    # https://stuartlab.org/signac/articles/pbmc_multiomic
    res_original <- Signac::LinkPeaks(
            ct_obj,
            peak.assay=pn,
            expression.assay='SCT',
            peak.slot = "counts",
            expression.slot = "data",
            method = "pearson",
            gene.coords = NULL,
            distance = 5e+05,
            min.distance = NULL,
            min.cells = 10,
            genes.use = unique(pairs_df$gene), #NULL,
            n_sample = 200,
            pvalue_cutoff = 1,#do not threshold by p value or score, to be comparable with other methods
            score_cutoff = 0,#0.05,
            gene.id = FALSE,
            verbose = TRUE)

    end <- Sys.time()
    print(end)
    print('Signac ended')

    saveRDS(end - start, sprintf('%s_Siganc_%s.rds', output_dir, fn))
}

# -
# SCENT
# -
if(!file.exists(sprintf('%s_SCENT_%i%%_%s.rds', output_dir, round(pair_prop*100), fn))){
    ct_var_name <- 'predicted.id'
    set.seed(2024)
    i_set_pair_inds <- sample(1:nrow(pairs_df), round(nrow(pairs_df)*pair_prop), replace=F)
    print(sprintf('total pairs: %i', nrow(pairs_df)))
    print(sprintf('%s pairs to run', length(i_set_pair_inds)))

    # extract counts
    peak_counts <- ct_obj[[pn]]@counts[unique(pairs_df$peak),]
    rna_counts <- ct_obj[['RNA']]@counts[unique(pairs_df$gene),]

    mdata <- ct_obj@meta.data
    mdata$cell <- rownames(mdata)
    mdata$log_total_counts <- log(colSums(ct_obj[['RNA']]@counts))
    covariates_set <- "log_total_counts"

    SCENT_obj <- CreateSCENTObj(rna = rna_counts, atac = peak_counts,
                                meta.data = mdata,
                                peak.info = pairs_df[i_set_pair_inds, c('gene', 'peak')],
                                covariates = covariates_set,
                                celltypes = ct_var_name)
    print('SCENT started')
    start <- Sys.time() 
    start %>% print
    SCENT_obj <- SCENT_algorithm(object = SCENT_obj, celltype = ct,
                             ncores = 1,
                             regr = 'poisson', bin = TRUE)
    end <- Sys.time()
    end %>% print
    print('SCENT ended')
    print(end - start)
    saveRDS(end - start, sprintf('%s_SCENT_%i%%_%s.rds', output_dir, round(pair_prop*100), fn))
}
